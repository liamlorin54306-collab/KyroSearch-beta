<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kyro-code</title>
<style>
  :root{
    --bg:#071026; --panel:#0f1b2b; --accent:#4aa3ff; --muted:#98a8b9; --user:#6ef29b; --bot:#ffd166;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#02101a);font-family:Inter,Arial,sans-serif;color:#e6eef6}
  .app{display:grid;grid-template-columns:320px 1fr;gap:18px;height:100vh;padding:18px}
  .sidebar{background:var(--panel);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
  .logo{font-weight:700;font-size:18px;color:var(--accent)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--accent);color:#042235;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted);padding:8px;border-radius:8px;cursor:pointer}
  .small{font-size:13px;padding:6px 8px}
  .memory-list{flex:1;overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,.01),transparent)}
  .mem-item{padding:8px;border-radius:8px;background:rgba(255,255,255,.02);margin-bottom:8px;font-size:13px}
  .mem-item strong{color:var(--bot)}
  .chat-panel{display:flex;flex-direction:column;gap:12px}
  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--panel);border-radius:12px}
  .chat-area{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.01),transparent);padding:14px;border-radius:12px;overflow:auto}
  .entry{position:fixed;left:360px;right:18px;bottom:18px;display:flex;gap:10px;align-items:center}
  .input{flex:1;background:#071726;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,.03);outline:none;color:#e6eef6}
  .msg{margin:8px 0;padding:10px;border-radius:10px;max-width:78%;}
  .msg.user{margin-left:auto;background:linear-gradient(90deg,#072b1a,#06311e);border:1px solid rgba(0,0,0,.4);color:var(--user)}
  .msg.bot{background:linear-gradient(90deg,#172331,#12222f);border:1px solid rgba(255,255,255,.03);color:var(--bot)}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .tag{display:inline-block;background:rgba(255,255,255,.02);padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center}
  .chip{background:rgba(255,255,255,.02);padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted)}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.03),transparent);margin:8px 0;border-radius:2px}
  .hint{font-size:13px;color:var(--muted)}
  .system-note{font-size:13px;color:#b7d4ff;background:rgba(74,163,255,.06);padding:8px;border-radius:8px}
  .export{background:transparent;border:1px dashed rgba(255,255,255,.06);color:var(--muted);padding:8px;border-radius:8px;cursor:pointer}
  /* responsive */
  @media (max-width:900px){.app{grid-template-columns:1fr;}.sidebar{display:none}.entry{left:18px}}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="logo">Kyro-code</div>
    <div class="hint">Fonctions : raisonnement multi-étapes, mémoire courte & longue (localStorage), contexte, extraction d'entités, apprentissage "teach".</div>
    <div class="controls">
      <button id="clearConv" class="small">Effacer conversation</button>
      <button id="exportConv" class="small ghost">Exporter</button>
      <button id="toggleMemory" class="small">Mémoire : ON</button>
      <button id="teachBtn" class="small">Mode TEACH</button>
    </div>

    <div class="divider"></div>

    <div style="font-weight:700">Mémoire courte</div>
    <div class="memory-list" id="memoryList"></div>

    <div class="divider"></div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="chip">Contexte : <span id="ctxSize">0</span></div>
      <div class="chip">Historique : <span id="histSize">0</span></div>
    </div>

    <div class="divider"></div>
    <div style="font-size:13px">
      <div style="font-weight:700;margin-bottom:6px">Astuce rapide</div>
      <div class="hint">- Dis "teach: X est Y" pour l'ajouter à la mémoire.<br>- Demande "explique X en étapes" pour un guide pas-à-pas.<br>- "résume" pour condenser l'historique.</div>
    </div>
  </aside>

  <section class="chat-panel">
    <div class="chat-header">
      <div>
        <div style="font-weight:700">Conversation</div>
        <div class="meta">Kyro-code — local | pas de réseau | pas de clés exposées</div>
      </div>
      <div class="toolbar">
        <div class="tag" id="modeTag">Mode: Normal</div>
        <div class="tag" id="memTag">Mémoire active</div>
      </div>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="system-note" id="systemNote">
        Kyro-code prêt. Pose une question, demande un guide, ou enseigne-lui quelque chose (format: <code>teach: sujet = info</code>).
      </div>
    </div>
  </section>
</div>

<div class="entry">
  <input id="inputField" class="input" placeholder="Écris ta demande — ex: 'explique comment fonctionne une API' ou 'teach: HTML = langage de structure'">
  <button id="sendBtn">Envoyer</button>
  <button id="shortBtn" class="ghost">Mode Court</button>
</div>

<script>
/* ------------------------------
   Kyro-code — impl local JS
   ------------------------------ */

/* Data stores */
const state = {
  history: [], // {role:'user'|'bot', text, time}
  memory: loadMemory(), // { topic:info }
  teachMode: false,
  memoryEnabled: true,
  mode: 'normal', // normal | terse | verbose
};

/* Helpers */
function now(){ return new Date().toISOString(); }
function el(id){ return document.getElementById(id); }

function saveMemory(){
  try{ localStorage.setItem('kyro_memory_v4', JSON.stringify(state.memory)); }catch(e){}
}
function loadMemory(){
  try{ const s = localStorage.getItem('kyro_memory_v4'); return s ? JSON.parse(s) : {}; }catch(e){ return {}; }
}

/* UI updates */
function refreshMemoryUI(){
  const list = el('memoryList'); list.innerHTML = '';
  const keys = Object.keys(state.memory);
  if(keys.length === 0){ list.innerHTML = '<div class="hint">Aucune mémoire enregistrée.</div>'; }
  keys.forEach(k=>{
    const d = document.createElement('div'); d.className='mem-item';
    d.innerHTML = `<strong>${k}</strong><div style="margin-top:6px;color:var(--muted);font-size:13px">${state.memory[k]}</div>`;
    list.appendChild(d);
  });
  el('ctxSize').textContent = Math.max(0, Math.min(50, state.history.length));
  el('histSize').textContent = state.history.length;
  el('memTag').textContent = state.memoryEnabled ? 'Mémoire active' : 'Mémoire OFF';
}

/* Append message */
function appendMessage(text, role, meta=''){
  const area = el('chatArea');
  const d = document.createElement('div'); d.className='msg '+(role==='user'?'user':'bot');
  d.innerHTML = `<div><b>${role==='user'?'Toi':'Kyro'}</b></div><div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(text)}</div>${meta?('<div class="meta">'+escapeHtml(meta)+'</div>'):''}`;
  area.appendChild(d);
  area.scrollTop = area.scrollHeight;
  state.history.push({role, text, time:now()});
  refreshMemoryUI();
}

/* Escape HTML */
function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Intent detection (multi-rule) */
function detectIntent(msg){
  const t = msg.toLowerCase();
  if(t.startsWith('teach:')) return 'teach';
  if(t.startsWith('forget:')) return 'forget';
  if(t.match(/^(résume|resume|résumer)\b/)) return 'summarize';
  if(t.match(/\b(explique|explain|puis-je|comment|pourquoi|comment faire|comment faire pour)\b/)) return 'explain';
  if(t.match(/\b(aide|help|solution|problème|bug)\b/)) return 'help';
  if(t.match(/\b(code|exemple|snippet|génère|générer)\b/)) return 'code';
  if(t.match(/\b(qu'est|c'est quoi|definition|définition|c est quoi)\b/)) return 'define';
  return 'chat';
}

/* Entity extraction (simple) */
function extractEntities(msg){
  const t = msg.toLowerCase();
  const entities = [];
  // common tech terms
  const terms = ['html','css','javascript','api','serveur','serveurs','node','python','express','react','mysql','sql','docker','git','github','linux','windows','navigateur','chrome','firefox'];
  for(const term of terms) if(t.includes(term)) entities.push(term);
  // dates / numbers
  const num = t.match(/\b(\d{1,4})\b/);
  if(num) entities.push(num[1]);
  return [...new Set(entities)];
}

/* Reasoning engine (simulated multi-step) */
function reasonChain(question, context){
  // step 1: detect intent & topic
  const intent = detectIntent(question);
  const entities = extractEntities(question);
  // step 2: pull memory-relevant facts
  const facts = [];
  if(state.memoryEnabled){
    for(const k in state.memory){
      if(question.toLowerCase().includes(k.toLowerCase()) || entities.includes(k.toLowerCase())) facts.push({k, v: state.memory[k]});
    }
  }
  // step 3: generate structured response pieces
  const pieces = [];
  if(intent === 'teach') {
    pieces.push("Mode TEACH détecté. Usage: teach: sujet = info");
    return {intent, reply: pieces.join('\n'), entities, facts};
  }
  if(intent === 'forget') {
    pieces.push("Mode FORGET détecté. Usage: forget: sujet");
    return {intent, reply: pieces.join('\n'), entities, facts};
  }
  if(facts.length){
    pieces.push("Mémoire pertinente:");
    facts.forEach(f=> pieces.push(`- ${f.k}: ${f.v}`));
  }
  // Info-layer: knowledge base fallback
  const kb = {
    html: "HTML structure le contenu d'une page web (titres, paragraphes, liens, images).",
    css: "CSS règle l'apparence : couleurs, mises en page, flex/grid, animations.",
    javascript: "JavaScript ajoute l'interactivité (DOM, événements, fetch, logique).",
    api: "Une API permet à deux systèmes de communiquer. REST et GraphQL sont courants.",
    serveur: "Un serveur écoute des requêtes et renvoie des réponses (HTTP).",
    python: "Python est un langage polyvalent, souvent utilisé pour le scripting et la data science.",
    docker: "Docker containerise des applications pour les rendre portables et isolées.",
    git: "Git est un système de contrôle de version distribué pour gérer le code source.",
    'open source': "L'open source permet la collaboration et le partage de code librement.",
    node: "Node.js est un environnement d'exécution JavaScript côté serveur.",
    404: "L'erreur 404 signifie que la ressource demandée est introuvable sur le serveur.",
    débogage: "Le débogage consiste à identifier et corriger les erreurs dans le code.",
  };
  for(const e of entities) if(kb[e]) pieces.push(`${e.toUpperCase()}: ${kb[e]}`);
  // If explain intent -> produce step-by-step
  if(intent === 'explain' || question.endsWith('?') || question.includes('comment')){
    const topic = entities[0] || extractTopicFromText(question) || 'le sujet';
    pieces.push(`Explication synthétique sur : ${topic}`);
    const steps = generateHowTo(topic);
    pieces.push('Étapes recommandées:\n' + steps.map((s,i)=>`${i+1}. ${s}`).join('\n'));
  } else if(intent === 'code'){
    pieces.push('Exemple de code disponible. Demande: "génère un exemple de X"');
  } else if(intent === 'summarize'){
    pieces.push(summarizeHistory());
  } else {
    // general conversational reply - simulate reasoning
    pieces.push(simulateThoughtfulReply(question, entities, facts));
  }

  // Compose answer with chain-of-thought summary (hidden-ish)
  const reply = pieces.join('\n\n');
  return {intent, reply, entities, facts};
}

/* Extract topic guess */
function extractTopicFromText(text){
  const t = text.toLowerCase();
  // try "c'est quoi X"
  const m = t.match(/c'?est quoi\s+(.+?)\?*$/);
  if(m) return m[1].trim();
  // try last noun-like token
  const tokens = t.split(/\s+/);
  return tokens.slice(-3).join(' ');
}

/* Simulated how-to generator */
function generateHowTo(topic){
  const t = (topic||'task').toLowerCase();
  if(t.includes('html')) return ['Créer un fichier .html','Définir structure <html><head><body>','Ajouter contenu sémantique','Tester dans navigateur'];
  if(t.includes('api')) return ['Définir routes et endpoints','Choisir format (JSON)','Implémenter serveur','Gérer authentification','Documenter'];
  if(t.includes('javascript')) return ['Définir le but','Écrire fonctions pures','Tester en console','Faire intégration DOM','Gérer erreurs'];
  if(t.includes('css')) return ['Choisir structure (flex/grid)','Définir styles de base','Ajouter responsive design','Tester sur différents écrans','Optimiser performances'];
  if(t.includes('docker')) return ['Installer Docker','Écrire Dockerfile','Construire image','Lancer conteneur','Gérer volumes et réseaux'];
  if(t.includes('git')) return ['Initialiser dépôt git','Ajouter fichiers','Faire commits réguliers','Créer branches pour features','Fusionner et résoudre conflits'];
  if(t.includes('python')) return ['Installer Python','Écrire script de base','Tester localement','Gérer dépendances avec venv','Exécuter et déboguer'];
  if(t.includes('node')) return ['Installer Node.js','Initialiser projet avec npm','Écrire serveur de base','Tester endpoints','Déployer sur plateforme'];
  if(t.includes('serveur')) return ['Choisir type de serveur','Configurer environnement','Écrire logique serveur','Tester avec requêtes','Surveiller performances'];
  if(t.includes('débogage') || ('debug')) return ['Identifier le bug','Reproduire le problème','Utiliser outils de débogage','Analyser causes possibles','Appliquer correctifs et tester'];
  if(t.includes('open source')) return ['Choisir licence open source','Publier le code sur une plateforme (GitHub)','Documenter projet','Encourager contributions','Gérer issues et pull requests'];
  if(t.includes('404') || ('erreur 404')) return ['Vérifier l\'URL demandée','Confirmer que la ressource existe','Examiner les règles de routage','Vérifier les permissions d\'accès','Consulter les logs du serveur'];
  if(t.includes('comment lier un fichier css a une page html')) return ['Créer le fichier CSS','Ajouter la balise <link> dans le <head> de la page HTML','Vérifier le chemin du fichier CSS','Tester le rendu dans le navigateur','Déboguer les problèmes de style'];
  if(t.includes('comment lier un fichier javascript a une page html')) return ['Créer le fichier JavaScript','Ajouter la balise <script> avant la fermeture du </body>','Vérifier le chemin du fichier JavaScript','Tester les fonctionnalités dans le navigateur','Déboguer les erreurs JavaScript'];
  if(t.includes('comment fonctionne une api')) return ['Comprendre les concepts d\'API','Choisir le type d\'API (REST, GraphQL)','Définir les endpoints et méthodes HTTP','Implémenter la logique côté serveur','Tester l\'API avec des outils comme Postman'];
  if(t.includes('quel est le meilleur éditeur de code')||('quel est la meilleure application de codage')||('quel est la meilleure application pour le codage')) return ['Identifier les besoins spécifiques','Comparer les fonctionnalités des éditeurs populaires','Tester les éditeurs avec des projets réels','Considérer la communauté et les extensions','Choisir celui qui convient le mieux','mais le logiciel utiliser pour cette page web est visual studio code'];
  if(t.includes(''))
    return ['Définir le résultat attendu','Casser le problème en étapes','Implémenter la première étape','Tester et itérer','Documenter la solution'];

}

/* Summarize history */
function summarizeHistory(){
  if(state.history.length === 0) return 'Aucun échange à résumer.';
  // pick up to last 12 messages
  const recent = state.history.slice(-12);
  const lines = recent.map(h => `${h.role==='user'?'Tu':'Kyro'}: ${h.text}`);
  // condense by simple heuristics
  return 'Résumé rapide:\n' + lines.join('\n');
}

/* Simulate a thoughtful reply */
function simulateThoughtfulReply(question, entities, facts){
  let out = '';
  if(facts.length){
    out += `Je me base sur ${facts.length} fait(s) enregistré(s).\n`;
  }
  if(entities.length){
    out += `Sujets détectés: ${entities.join(', ')}.\n\n`;
  }
  out += `Réponse directe synthétique :\n`;
  out += quickKnowledgeAnswer(question, entities) || 'Je n’ai pas d’info complète — précise ta demande pour un guide détaillé.';
  return out;
}

/* Quick knowledge */
function quickKnowledgeAnswer(q, entities){
  if(entities.includes('html')) return 'HTML est la langue de structure des pages web. Il utilise <header>, <main>, <footer> pour sémantique.';
  if(entities.includes('css')) return 'CSS contrôle le styles : flex/grid pour layout, variables pour thèmes, media queries pour responsive.';
  if(entities.includes('javascript')) return 'JS gère logique : fetch pour appels, events pour interactions, promises/async pour asynchronicité.';
  if(entities.includes('api')) return 'API = interface ; utilise endpoints REST + JSON ; sécurise par tokens.';
  if(entities.includes('serveur')) return 'Un serveur web écoute requêtes HTTP et renvoie réponses. Node.js est populaire pour ça.';
  if(entities.includes('python')) return 'Python est un langage polyvalent, souvent utilisé pour scripts, data science, web dev (Django, Flask).';
  if(entities.includes('docker')) return 'Docker containerise applications pour portabilité. Utilise Dockerfile pour définir limages.';
  if(entities.includes('git')) return 'Git est un système de versionnage distribué. Utilise commits, branches, merges pour gérer code.';
  if(entities.includes('open source')||('l’open source')) return 'L’open source permet collaboration et transparence. Contribue via forks, pull requests, issues.';
  if(entities.includes('node')) return 'Node.js est un runtime JS côté serveur.';
  if(entities.includes('404')||('erreur 404')) return 'Erreur 404 signifie que la ressource demandée est introuvable sur le serveur.';
  if(entities.includes('débogage')||('débug')) return 'Le débogage consiste à identifier et corriger les erreurs dans le code. Utilise console.log, breakpoints, outils dédiés.';
  return null;
}

/* Teach/forget handlers */
function handleTeach(raw){
  // expected: teach: sujet = info
  const m = raw.match(/^teach:\s*([^=]+)\s*=\s*(.+)$/i);
  if(!m) return 'Format invalide. Utilise: teach: sujet = info';
  const key = m[1].trim();
  const val = m[2].trim();
  state.memory[key] = val;
  saveMemory();
  return `Mémoire ajoutée: ${key} = ${val}`;
}
function handleForget(raw){
  // expected: forget: sujet
  const m = raw.match(/^forget:\s*(.+)$/i);
  if(!m) return 'Format invalide. Utilise: forget: sujet';
  const key = m[1].trim();
  if(state.memory[key]){ delete state.memory[key]; saveMemory(); return `Oublié: ${key}`; }
  return `Rien trouvé pour: ${key}`;
}

/* Main generator */
function generateResponse(userText){
  // teach/forget shortcut
  const intent = detectIntent(userText);
  if(intent === 'teach') return handleTeach(userText);
  if(intent === 'forget') return handleForget(userText);

  // reasoning chain
  const chain = reasonChain(userText, state);
  let reply = chain.reply || '';

  // Add context-aware adjustment
  if(state.mode === 'terse') reply = shorten(reply);
  if(state.mode === 'verbose') reply = expandVerbose(reply, chain);

  // memory auto-save: if response contains an explicit fact taught by user pattern "X est Y"
  const teachPattern = userText.match(/^(.+?)\s+est\s+(.+)$/i);
  if(teachPattern && userText.length < 200){
    const k = teachPattern[1].trim();
    const v = teachPattern[2].trim();
    if(k && v) { state.memory[k] = v; saveMemory(); reply += `\n\n(Mémoire auto-ajoutée: ${k})`; }
  }

  return reply;
}

/* Utility transforms */
function shorten(text){ return text.split('\n').slice(0,3).join('\n') + (text.split('\n').length>3?' ...':''); }
function expandVerbose(text, chain){ return text + '\n\n[Mode verbose] Détails: ' + JSON.stringify(chain, null, 2); }

/* Event wiring */
el('sendBtn').addEventListener('click', ()=>{ submitInput(); });
el('inputField').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submitInput(); }});
el('clearConv').addEventListener('click', ()=>{ el('chatArea').innerHTML=''; state.history = []; refreshMemoryUI(); });
el('exportConv').addEventListener('click', ()=>{ const data = JSON.stringify(state.history, null, 2); downloadFile('kyro_conversation.json', data); });
el('toggleMemory').addEventListener('click', ()=>{ state.memoryEnabled = !state.memoryEnabled; el('toggleMemory').textContent = 'Mémoire : ' + (state.memoryEnabled?'ON':'OFF'); refreshMemoryUI(); });
el('teachBtn').addEventListener('click', ()=>{ state.teachMode = !state.teachMode; el('modeTag').textContent = state.teachMode ? 'Mode: TEACH' : 'Mode: Normal'; });

el('shortBtn').addEventListener('click', ()=>{
  state.mode = state.mode === 'terse' ? 'normal' : 'terse';
  el('modeTag').textContent = `Mode: ${state.mode}`;
});

/* submit flow */
function submitInput(){
  const raw = el('inputField').value.trim();
  if(!raw) return;

  // --- the mémorie ---
  if(raw.toLowerCase() === 'effacer la mémoire') {
    state.memory = {};
    saveMemory();
    refreshMemoryUI();
    appendMessage('Mémoire effacée.', 'bot');
    el('inputField').value = '';
    return;
  }

  appendMessage(raw, 'user');
  el('inputField').value = '';
  // immediate local quick reply while "thinking"
  appendMessage('...', 'bot');
  setTimeout(()=>{ // simulate async reasoning
    // remove last '...' bot placeholder
    const area = el('chatArea'); 
    const msgs = area.querySelectorAll('.msg.bot');
    if(msgs.length) msgs[msgs.length-1].remove();
    try{
      const resp = generateResponse(raw);
      appendMessage(resp, 'bot');
    }catch(e){
      appendMessage('Erreur interne lors de la génération de réponse.', 'bot');
      console.error(e);
    }
  }, 250);
}


/* Download helper */
function downloadFile(name, content){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], {type:'application/json'}));
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* Init */
refreshMemoryUI();
appendMessage('Kyro-code prêt. Essaie: "explique comment fonctionne une API" ou "teach: Node = runtime JS".', 'bot', 'Système');

/* Expose for console tinkering */
window.Kyro = { state, generateResponse, reasonChain, saveMemory, loadMemory };

</script>
</body>
</html>
